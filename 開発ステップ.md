# 開発ステップ

最初に、技術確認・機能確認のためにプロトタイプ版を構築します。
動作検証後、MVPに発展します

## プロトタイプ版

### ホスティング
- バックエンド: Render.com（コンテナサービス）
- フロントエンド: Render.com（静的サイト）
    - Blazor WASM のSPAルーティング対応として、リライト規則: `/* -> /index.html 200`

### ソースコード管理
- ローカル: git
- リモート: GitHub

### 開発環境
- バックエンド
    - Docker: .NET
    - Database: PostgreSQL（コンテナ内のPostgreSQL）
    - 認証: ログイン（JWT）
- フロントエンド
    - Docker: .NET　ローカル開発のみ

#### データベース/接続情報
- 利用: コンテナ内のPostgreSQL
- 環境変数: `DATABASE_URL`（Render提供の接続文字列を使用、SSL必須）
- シークレット管理: Render の Environment / Secret で管理

### デプロイ
- スクリプト: GitHub Actions
    - Render へのデプロイは GitHub 連携の Auto Deploy（main ブランチ）
    - フロント（静的）
        - Build: `dotnet publish -c Release`
        - PublishDir: `frontend/bin/Release/net8.0/publish/wwwroot`
    - バックエンド（コンテナ）
        - Dockerfile: `backend/Dockerfile`
        - ポート: Render の `PORT` をリッスン（`ASPNETCORE_URLS=http://0.0.0.0:$PORT`）
        - CORS: フロントの本番URLのみ許可

### 確認事項
- バックエンド
    - PostgreSQLを操作するDapperを検証
    - あらかじめ登録したログインID/パスワードを利用したJWT認証を検証
- フロントエンド
    - Blazor WebAssemblyの開発方法を検証
    - UI MudBlazorの機能・動作を検証
    - PWA機能・動作を検証

### 認証/セキュリティ設計
- 初期ユーザー投入: シードスクリプト（起動時 or 管理用コマンド）
- パスワードハッシュ: PBKDF2（塩+反復）
- JWT:
  - 署名鍵: `JWT_SIGNING_KEY` をRenderのSecretで管理
  - 有効期限: 15〜60分（プロトタイプはリフレッシュトークン無し）
  - ヘッダ経由でAPI保護、ロール/スコープは最低限
- CORS: フロントの静的サイトURLのみ許可、認証ヘッダを許可

### マイグレーション
- 方針: Dapper利用のため、アプリ内でDbUpを使ってSQLスクリプトを適用
- スクリプト配置: `backend/migrations`（例: `001_init.sql`, `002_add_table_x.sql`）
- 適用タイミング: バックエンド起動時に自動適用（本番は安全のため明示フラグで制御可）

### リポジトリ構成
- モノレポ: `backend/` と `frontend/`
- CIのパスフィルタ: `backend/**` 変更時のみバックエンドをビルド/デプロイ、`frontend/**` はフロントのみ

### 受け入れ条件（プロトタイプ完了基準）
- シードユーザーでサインインしJWTを取得できる
- 認証必須API（CRUD 1系統）がJWTで保護されている
- DapperでDB CRUDが成功し、マイグレーションが適用される
- フロントからバックのAPI呼び出しがCORS許可で成功する
- フロント/バックともにRenderにデプロイ済みで動作確認できる
- SPAルーティング（直接URLアクセス）がリライト規則で動作する


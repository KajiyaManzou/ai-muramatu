# 地域限定情報発信アプリ 企画書

## 概要
地域から情報を発信し、全国に地域の情報を提供するWebアプリケーション（PWA）。
初期は企画実験なので、無料で開発・運用し、段階的に拡張する。

## ターゲット
- **メイン対象年齢**:  30代〜40代
   - 子育て世代による情報発信を目指す
- **コンテンツ提供対象者**: オープン
- **コンテンツ登録**: 段階的に拡大
   - **初期段階**: 企画グループが地域からコンテンツを収集しコンテンツ登録
   - **中期段階**: 店舗、自治体、学校などに協力を要請しコンテンツ登録
   - **その後**: コンテンツ登録希望者を登録しコンテンツ登録
   - **コンテンツ品質確保**: モデレーターによる品質確保。最初は人的精査を実施し、可能ならAIによる精査に切り替える。

## システム構成

### フロントエンド（PWA）
- **フレームワーク**: .NET Blazor WebAssembly
   - 初期ロード: AOT/Trimming最適化を前提に許容
- **PWA機能**: Service Worker + Web App Manifest（静的資産はCache First、APIはSWR）
- **UI**: MudBlazor
- **ホスティング**: Render.com（静的サイト）

### バックエンド
- **フレームワーク**: .NET C#
- **API**: Web API（RESTful）
- **データベース**: Supabase（PostgreSQL）
- **認証**: Supabase Auth
- **ホスティング**: Render.com（コンテナサービス）

### ソースコード管理
- **ローカル**: git
- **リモート**: GitHub

## デプロイ
- **スクリプト**: GitHub Actions

## 開発環境

### 開発マシン
- MacBookAir 2024 : CPU M3, RAM 24GB, SSD 1TB
- Docker: フロントエンド、バックエンドを別のDockerコンテナ
- Editor: cursor
   - DevContainer

### フロントエンド
- Docker: .NET 

### バックエンド
- Docker: .NET 

### 地域機能
- **位置情報**: Web Geolocation API（権限は任意）
- **地図**: Leaflet + MapTiler（OpenStreetMapタイル, 無料枠／APIキーはRender Secretsで管理）
- **プッシュ通知**: Web Push API（VAPID, iOSはホーム画面追加後）
  - VAPIDキー: Render Secretsで管理（`VAPID_PUBLIC_KEY`/`VAPID_PRIVATE_KEY`）
  - 同意UI: 初回は未要求。設定画面の「通知を有効化」操作で許可ダイアログを案内
  - 購読管理: endpoint/p256dh/authを保存。退会/端末解除で購読を削除

### 運用・分析（無料枠活用）
- アナリティクス: Umami／Cloudflare Web Analytics
- エラートラッキング: Sentry（フロント/バックエンド）
- ログ: 構造化ログ（Serilog→STDOUT→Renderログ）
- アラート: エラー率・応答時間の閾値通知

## 認証システム

### 基本認証
- **メールアドレス認証（メイン）**: Supabase Auth メール+パスワード
   - **パスワードリセット**: Supabase Auth（メール + マジックリンク）
- **SNS認証（サブ）**: Supabase Auth OAuth（Google／GitHub／Facebook／Apple）

### データアクセス制御（RLS草案）
- posts: 作成者はCRUD、公開ステータス（status='published'）のみ全体閲覧可。moderator/adminは全件管理可。
- reports: 申告者は自分の通報のみ閲覧可。moderator/adminは全件閲覧・更新可。
- push_subscriptions: 当該ユーザーのみCRUD。
- users/places: 必要最小限の列のみ公開。管理操作はadmin限定。

### JWT/セッション方針
- フロントはSupabase Authのアクセストークンを取得し、API呼び出し時に`Authorization: Bearer <JWT>`を付与。
- バックエンドはSupabaseのJWKsでJWT署名を検証し、`sub`/`exp`/`aud`をチェック。
- データアクセスは原則PostgREST経由でユーザーJWTを透過し、RLSで権限制御（管理系のみService Role Keyを限定使用）。


### 地域限定実装
1. **招待制**
   - 招待コードによる制限
   
2. **段階的認証フロー**
   - 招待コード入力

3. **表示パーソナライズ**
   - 位置情報はフィードの並び替え/タグ付けに利用（強制的なアクセス制限には不使用）

### 招待コード配布方法
- 既存ユーザーからの招待

## 年齢層別配慮
- **10-20代**: LINE/Twitter風のシンプルUI
- **30-40代**: セキュリティ説明、プライバシー配慮重視

## 運用方針
- **初期**: 招待制で小規模開始
- **成長段階**: コミュニティ育成後、段階的に制限緩和
- **コスト**: 無料枠活用で月額0円からスタート
- **拡張**: トラフィック増加時に有料プランへ段階的移行
- **モデレーション設計**
   - 役割: admin/moderator/contributor/viewer
   - 受付: 通報→レビュー→措置（非表示/修正/凍結）
   - ルール: 投稿ガイドライン/TOS、未成年配慮、個人情報・誹謗中傷・著作権の明確化

## MVP機能スコープ（初期リリース）
- 招待制＋基本認証（Supabase Auth統一）
- 投稿/閲覧（テキスト＋画像1枚、位置タグ、カテゴリ）
- 一覧/詳細/地域優先のフィード（近距離優先）
- 通報とモデレーション簡易フロー
- PWA基本（オフラインの簡易キャッシュ）
- 分析（エラー＋基本PV）

## 簡易データモデル（案）
- users: id, display_name, role, created_at
- places: id, name, lat, lon, tags
- posts: id, user_id, place_id, title, body, images[], tags[], status, created_at
- reports: id, post_id, reporter_id, reason, created_at, status
- push_subscriptions: id, user_id, endpoint, p256dh, auth, created_at
